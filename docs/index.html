<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRQ Stock Prediction Validation</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        .content {
            padding: 30px;
        }
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .control-group label {
            font-weight: 600;
            color: #333;
        }
        select, input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        .stat-card .subtitle {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            border-left: 4px solid #c33;
        }
        .no-data {
            background: #f0f8ff;
            color: #0066cc;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            border-left: 4px solid #0066cc;
        }
        .stock-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .stock-table th,
        .stock-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .stock-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        .stock-table tr:hover {
            background: #f8f9fa;
        }
        .performance-positive {
            color: #28a745;
            font-weight: bold;
        }
        .performance-negative {
            color: #dc3545;
            font-weight: bold;
        }
        .performance-neutral {
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>GRQ Stock Prediction Validation</h1>
            <p>Validating AI predictions against 90-day targets and 10% annual cost of capital</p>
        </div>
        
        <div class="content">
            <div class="controls">
                <div class="control-group">
                    <label for="scoreFileSelect">Score File:</label>
                    <select id="scoreFileSelect">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="costOfCapital">Cost of Capital (% per year):</label>
                    <input type="number" id="costOfCapital" value="10" min="0" max="100" step="0.1">
                </div>
            </div>

            <div id="loading" class="loading">
                Loading data...
            </div>

            <div id="error" class="error" style="display: none;"></div>
            <div id="noData" class="no-data" style="display: none;">
                No market data available yet for this score file. Data will appear as it becomes available.
            </div>

            <div id="summary" style="display: none;">
                <div class="summary-stats">
                    <div class="stat-card">
                        <h3>Average Target Gain</h3>
                        <div class="value" id="avgTargetGain">-</div>
                        <div class="subtitle">90-day prediction</div>
                    </div>
                    <div class="stat-card">
                        <h3>Current Performance</h3>
                        <div class="value" id="currentPerformance">-</div>
                        <div class="subtitle">vs target</div>
                    </div>
                    <div class="stat-card">
                        <h3>Cost of Capital</h3>
                        <div class="value" id="costOfCapitalDisplay">-</div>
                        <div class="subtitle">90-day equivalent</div>
                    </div>
                    <div class="stat-card">
                        <h3>Days Elapsed</h3>
                        <div class="value" id="daysElapsed">-</div>
                        <div class="subtitle">since prediction</div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>

                <div id="stockDetails">
                    <h3>Individual Stock Performance</h3>
                    <table class="stock-table" id="stockTable">
                        <thead>
                            <tr>
                                <th>Stock</th>
                                <th>Target Price</th>
                                <th>Current Price</th>
                                <th>Target Gain (%)</th>
                                <th>Current Gain (%)</th>
                                <th>Progress</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        class GRQValidator {
            constructor() {
                this.scoreData = null;
                this.marketData = null;
                this.selectedScoreFile = null;
                this.costOfCapital = 10; // 10% per year
                this.chart = null;
                this.scoreFileDates = {}; // Map file path to date
                
                this.initializeEventListeners();
                this.loadScoreFiles();
            }

            initializeEventListeners() {
                document.getElementById('scoreFileSelect').addEventListener('change', (e) => {
                    this.selectedScoreFile = e.target.value;
                    if (this.selectedScoreFile) {
                        this.loadData();
                    }
                });

                document.getElementById('costOfCapital').addEventListener('input', (e) => {
                    this.costOfCapital = parseFloat(e.target.value) || 10;
                    this.updateDisplay();
                });
            }

            async loadScoreFiles() {
                try {
                    const response = await fetch('scores/index.json');
                    const indexData = await response.json();
                    
                    const select = document.getElementById('scoreFileSelect');
                    select.innerHTML = '';
                    
                    indexData.scores.forEach(score => {
                        const option = document.createElement('option');
                        option.value = score.file;
                        option.textContent = `${score.date} (${score.month} ${score.day})`;
                        select.appendChild(option);
                        this.scoreFileDates[score.file] = score.date; // Store the date
                    });

                    if (indexData.scores.length > 0) {
                        this.selectedScoreFile = indexData.scores[0].file;
                        select.value = this.selectedScoreFile;
                        this.loadData();
                    }
                } catch (error) {
                    this.showError('Failed to load score files: ' + error.message);
                }
            }

            async loadData() {
                this.showLoading();
                
                try {
                    await Promise.all([
                        this.loadScoreData(),
                        this.loadMarketData()
                    ]);
                    
                    this.updateDisplay();
                } catch (error) {
                    this.showError('Failed to load data: ' + error.message);
                }
            }

            async loadScoreData() {
                const response = await fetch(`scores/${this.selectedScoreFile}`);
                const text = await response.text();
                
                const lines = text.split('\n').filter(line => line.trim());
                const headers = lines[0].split('\t');
                
                this.scoreData = lines.slice(1).map(line => {
                    const values = line.split('\t');
                    const stock = values[0];
                    const score = parseFloat(values[1]);
                    const target = parseFloat(values[2]);
                    const exDividendDate = values[3] || null;
                    const dividendPerShare = parseFloat(values[4]) || 0;
                    
                    return {
                        stock,
                        score,
                        target,
                        exDividendDate,
                        dividendPerShare
                    };
                });
            }

            async loadMarketData() {
                const csvFile = this.selectedScoreFile.replace('.tsv', '.csv');
                
                try {
                    const response = await fetch(`scores/${csvFile}`);
                    const text = await response.text();
                    
                    if (!text.trim()) {
                        this.marketData = null;
                        return;
                    }
                    
                    const lines = text.split('\n').filter(line => line.trim());
                    const headers = lines[0].split(',');
                    
                    this.marketData = {};
                    
                    lines.slice(1).forEach(line => {
                        const values = line.split(',');
                        const date = values[0];
                        const ticker = values[1];
                        const high = parseFloat(values[2]);
                        const low = parseFloat(values[3]);
                        const open = parseFloat(values[4]);
                        const close = parseFloat(values[5]);
                        
                        if (!this.marketData[ticker]) {
                            this.marketData[ticker] = [];
                        }
                        
                        this.marketData[ticker].push({
                            date: new Date(date),
                            high,
                            low,
                            open,
                            close
                        });
                    });
                } catch (error) {
                    console.warn('No market data available yet:', error.message);
                    this.marketData = null;
                }
            }

            updateDisplay() {
                if (!this.scoreData) {
                    this.showError('No score data available');
                    return;
                }

                if (!this.marketData || Object.keys(this.marketData).length === 0) {
                    this.showNoData();
                    return;
                }

                this.hideMessages();
                this.updateSummaryStats();
                this.updateChart();
                this.updateStockTable();
            }

            updateSummaryStats() {
                const scoreDateStr = this.scoreFileDates[this.selectedScoreFile];
                const scoreDate = new Date(scoreDateStr);
                const today = new Date();
                const daysElapsed = Math.floor((today - scoreDate) / (1000 * 60 * 60 * 24));

                // Calculate average target gain
                const avgTargetGain = this.scoreData.reduce((sum, stock) => {
                    const marketData = this.marketData[stock.stock];
                    if (marketData && marketData.length > 0) {
                        const initialPrice = marketData[0].high; // Buy at high on score date
                        const targetGain = ((stock.target - initialPrice) / initialPrice) * 100;
                        return sum + targetGain;
                    }
                    return sum;
                }, 0) / this.scoreData.length;

                // Calculate current performance
                const currentPerformance = this.scoreData.reduce((sum, stock) => {
                    const marketData = this.marketData[stock.stock];
                    if (marketData && marketData.length > 0) {
                        const initialPrice = marketData[0].high; // Buy at high on score date
                        const currentPrice = marketData[marketData.length - 1].low; // Use low for subsequent days
                        const actualGain = ((currentPrice - initialPrice) / initialPrice) * 100;
                        return sum + actualGain;
                    }
                    return sum;
                }, 0) / this.scoreData.length;

                // Cost of capital for 90 days
                const costOfCapital90Days = (Math.pow(1 + this.costOfCapital / 100, 90 / 365) - 1) * 100;

                document.getElementById('avgTargetGain').textContent = avgTargetGain.toFixed(2) + '%';
                document.getElementById('currentPerformance').textContent = currentPerformance.toFixed(2) + '%';
                document.getElementById('costOfCapitalDisplay').textContent = costOfCapital90Days.toFixed(2) + '%';
                document.getElementById('daysElapsed').textContent = daysElapsed;

                // Color coding
                const currentEl = document.getElementById('currentPerformance');
                if (currentPerformance > costOfCapital90Days) {
                    currentEl.className = 'value performance-positive';
                } else if (currentPerformance < costOfCapital90Days) {
                    currentEl.className = 'value performance-negative';
                } else {
                    currentEl.className = 'value performance-neutral';
                }
            }

            updateChart() {
                const ctx = document.getElementById('performanceChart').getContext('2d');
                
                if (this.chart) {
                    this.chart.destroy();
                }

                const scoreDateStr = this.scoreFileDates[this.selectedScoreFile];
                const scoreDate = new Date(scoreDateStr);
                const costOfCapital90Days = (Math.pow(1 + this.costOfCapital / 100, 90 / 365) - 1) * 100;

                // Prepare data for chart
                const dates = [];
                const targetLine = [];
                const costOfCapitalLine = [];
                const actualPerformance = [];

                // Generate data points for 90 days
                for (let i = 0; i <= 90; i++) {
                    const date = new Date(scoreDate);
                    date.setDate(date.getDate() + i);
                    dates.push(date);

                    // Target line (linear progression to target)
                    const targetProgress = (i / 90) * 100; // Assuming average target is 100%
                    targetLine.push(targetProgress);

                    // Cost of capital line (compound growth)
                    const costOfCapitalProgress = (Math.pow(1 + this.costOfCapital / 100, i / 365) - 1) * 100;
                    costOfCapitalLine.push(costOfCapitalProgress);

                    // Actual performance (if we have data)
                    if (i <= this.getDaysElapsed()) {
                        const actual = this.calculateActualPerformance(i);
                        actualPerformance.push(actual);
                    } else {
                        actualPerformance.push(null);
                    }
                }

                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [
                            {
                                label: 'Target Performance',
                                data: targetLine,
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                borderWidth: 2,
                                fill: false
                            },
                            {
                                label: 'Cost of Capital (10% annual)',
                                data: costOfCapitalLine,
                                borderColor: '#dc3545',
                                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                borderWidth: 2,
                                fill: false
                            },
                            {
                                label: 'Actual Performance',
                                data: actualPerformance,
                                borderColor: '#007bff',
                                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                borderWidth: 3,
                                fill: false,
                                pointRadius: 4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day'
                                },
                                title: {
                                    display: true,
                                    text: 'Days Since Prediction'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Performance (%)'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Stock Performance vs Targets and Cost of Capital'
                            },
                            legend: {
                                position: 'top'
                            }
                        }
                    }
                });
            }

            calculateActualPerformance(daysElapsed) {
                if (!this.marketData) return null;

                let totalGain = 0;
                let validStocks = 0;

                this.scoreData.forEach(stock => {
                    const marketData = this.marketData[stock.stock];
                    if (marketData && marketData.length > 0) {
                        const initialPrice = marketData[0].high; // Buy at high on score date
                        const currentPrice = marketData[Math.min(daysElapsed, marketData.length - 1)].low; // Use low for subsequent days
                        const gain = ((currentPrice - initialPrice) / initialPrice) * 100;
                        totalGain += gain;
                        validStocks++;
                    }
                });

                return validStocks > 0 ? totalGain / validStocks : null;
            }

            getDaysElapsed() {
                const scoreDateStr = this.scoreFileDates[this.selectedScoreFile];
                const scoreDate = new Date(scoreDateStr);
                const today = new Date();
                return Math.floor((today - scoreDate) / (1000 * 60 * 60 * 24));
            }

            updateStockTable() {
                const tbody = document.getElementById('stockTableBody');
                tbody.innerHTML = '';

                this.scoreData.forEach(stock => {
                    const row = document.createElement('tr');
                    const marketData = this.marketData[stock.stock];
                    
                    if (marketData && marketData.length > 0) {
                        const initialPrice = marketData[0].high; // Buy at high on score date
                        const currentPrice = marketData[marketData.length - 1].low; // Use low for subsequent days
                        const targetGain = ((stock.target - initialPrice) / initialPrice) * 100;
                        const currentGain = ((currentPrice - initialPrice) / initialPrice) * 100;
                        const progress = (currentGain / targetGain) * 100;

                        row.innerHTML = `
                            <td><strong>${stock.stock}</strong></td>
                            <td>$${stock.target.toFixed(2)}</td>
                            <td>$${currentPrice.toFixed(2)}</td>
                            <td class="${targetGain >= 0 ? 'performance-positive' : 'performance-negative'}">${targetGain.toFixed(2)}%</td>
                            <td class="${currentGain >= 0 ? 'performance-positive' : 'performance-negative'}">${currentGain.toFixed(2)}%</td>
                            <td class="${progress >= 100 ? 'performance-positive' : progress >= 0 ? 'performance-neutral' : 'performance-negative'}">${progress.toFixed(1)}%</td>
                        `;
                    } else {
                        row.innerHTML = `
                            <td><strong>${stock.stock}</strong></td>
                            <td>$${stock.target.toFixed(2)}</td>
                            <td>No data</td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                        `;
                    }

                    tbody.appendChild(row);
                });
            }

            showLoading() {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('summary').style.display = 'none';
                document.getElementById('error').style.display = 'none';
                document.getElementById('noData').style.display = 'none';
            }

            showError(message) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('summary').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('noData').style.display = 'none';
                document.getElementById('error').textContent = message;
            }

            showNoData() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('summary').style.display = 'none';
                document.getElementById('error').style.display = 'none';
                document.getElementById('noData').style.display = 'block';
            }

            hideMessages() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'none';
                document.getElementById('noData').style.display = 'none';
                document.getElementById('summary').style.display = 'block';
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new GRQValidator();
        });
    </script>
</body>
</html> 