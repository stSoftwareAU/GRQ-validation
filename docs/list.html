<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    >
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script>
        const VERSION="1.0.76";
        document.title=`GRQ Score Files List v${VERSION}`;
    </script>
    <link rel="icon" type="image/png" href="logo.png" />

    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >

    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/datetime/1.5.0/css/dataTables.dateTime.min.css">

    <!-- Custom styles -->
    <link rel="stylesheet" href="styles.css">

    <style>
        .performance-positive {
            color: #10b981 !important;
            font-weight: 600;
        }
        .performance-negative {
            color: #ef4444 !important;
            font-weight: 600;
        }
        .performance-neutral {
            color: #6b7280 !important;
        }
        .date-filter-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            color: white;
        }
        .date-filter-container label {
            color: white;
            font-weight: 600;
        }
        .date-filter-container .form-control,
        .date-filter-container .form-select {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 8px;
        }
        .summary-stats {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
        }
        .summary-stat {
            text-align: center;
            padding: 15px;
        }
        .summary-stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .summary-stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        .table-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
        }
        .table-header h5 {
            color: white;
            margin: 0;
        }
        .dataTables_wrapper {
            padding: 20px;
        }
        .dataTables_wrapper .dataTables_filter {
            margin-bottom: 20px;
        }
        .dataTables_wrapper .dataTables_length {
            margin-bottom: 20px;
        }
        .dataTables_wrapper .dataTables_buttons {
            margin-bottom: 20px;
        }
        .dataTables_wrapper .dt-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .dataTables_wrapper .dt-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border: none !important;
            border-radius: 8px !important;
            padding: 8px 16px !important;
            font-size: 0.9rem !important;
            font-weight: 500 !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            text-decoration: none !important;
        }
        .dataTables_wrapper .dt-button:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%) !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important;
            color: white !important;
            text-decoration: none !important;
        }
        .dataTables_wrapper .dt-button:focus {
            color: white !important;
            text-decoration: none !important;
        }
        .dataTables_wrapper .dt-button:active {
            color: white !important;
            text-decoration: none !important;
        }
        .dataTables_wrapper .dt-button span {
            color: white !important;
        }
        .dataTables_wrapper .dt-button i {
            color: white !important;
        }
        .btn-view {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-view:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            color: white;
        }
        .btn-clear-filters {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-clear-filters:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            color: white;
        }
        .table {
            width: 100% !important;
        }
        .table th {
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            color: white;
            font-weight: 600;
            border: none;
            padding: 15px 10px;
        }
        .table td {
            padding: 12px 10px;
            vertical-align: middle;
        }
        .table tbody tr:hover {
            background-color: #f8fafc;
        }
        .card-header.header-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .btn-outline-primary {
            border-color: #667eea;
            color: #667eea;
        }
        .btn-outline-primary:hover {
            background-color: #667eea;
            border-color: #667eea;
        }
        
        /* Enhanced search box styling */
        .dataTables_filter input {
            border-radius: 20px !important;
            border: 2px solid #e9ecef !important;
            padding: 8px 15px !important;
            font-size: 14px !important;
            transition: all 0.3s ease !important;
        }
        
        .dataTables_filter input:focus {
            border-color: #667eea !important;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25) !important;
            outline: none !important;
        }
        
        .dataTables_filter label {
            font-weight: 600 !important;
            color: #495057 !important;
        }
    </style>

  </head>
  <body class="bg-light">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <div class="card shadow-sm border-0">
            <div class="card-header header-gradient text-white text-center py-4">
              <h1 class="display-4 mb-2">GRQ Score Files Performance</h1>
              <p class="lead mb-0">
                Track 90-day performance across all score files
              </p>
            </div>

            <div class="card-body p-4">
              <!-- Navigation -->
              <div class="row mb-4">
                <div class="col-12">
                  <a href="index.html" class="btn btn-outline-primary">
                    ‚Üê Back to Dashboard
                  </a>
                </div>
              </div>

              <!-- Loading and Error Messages -->
              <div id="loading" class="loading text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading score files...</p>
              </div>

              <div id="error" class="alert alert-danger" style="display: none">
              </div>

              <!-- Content -->
              <div id="content" style="display: none">
                <!-- Date Filters -->
                <div class="date-filter-container">
                  <div class="row">
                    <div class="col-md-3">
                      <label for="startDate" class="form-label fw-bold">Start Date:</label>
                      <input type="date" id="startDate" class="form-control">
                    </div>
                    <div class="col-md-3">
                      <label for="endDate" class="form-label fw-bold">End Date:</label>
                      <input type="date" id="endDate" class="form-control">
                    </div>
                    <div class="col-md-3">
                      <label for="performanceFilter" class="form-label fw-bold">Performance Filter:</label>
                      <select id="performanceFilter" class="form-select">
                        <option value="">All Performance</option>
                        <option value="positive">Positive Only</option>
                        <option value="negative">Negative Only</option>
                        <option value="above10">Above 10%</option>
                        <option value="below-10">Below -10%</option>
                      </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                      <button id="clearFilters" class="btn btn-clear-filters w-100">
                        <i class="fas fa-eraser me-1"></i>Clear Filters
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Score Files Table -->
                <div class="table-container">
                  <div class="table-header">
                    <h5 class="card-title mb-0">
                      <i class="fas fa-table me-2"></i>
                      Score Files Performance Summary
                    </h5>
                    <div class="alert alert-info mt-3 mb-0">
                      <small>
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>Search Tips:</strong> You can search by date (e.g., "2025-06" for June 2025), file name, or use the filters above for more specific results.
                      </small>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table
                      class="table table-hover score-files-table mb-0"
                      id="scoreFilesTable"
                    >
                      <thead class="table-dark">
                        <tr>
                          <th>Date</th>
                          <th>File</th>
                          <th>Total Stocks</th>
                          <th>90-Day Performance</th>
                          <th>Annualized Performance</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody id="scoreFilesTableBody"></tbody>
                    </table>
                  </div>
                </div>

                <!-- Summary Statistics -->
                <div class="summary-stats">
                  <h4 class="text-center mb-4">
                    <i class="fas fa-chart-line me-2"></i>
                    Performance Summary for Selected Files
                  </h4>
                  <div class="row">
                    <div class="col-md-3">
                      <div class="summary-stat">
                        <div class="summary-stat-value" id="avg90Day">-</div>
                        <div class="summary-stat-label">Avg 90-Day Performance</div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="summary-stat">
                        <div class="summary-stat-value" id="avgAnnualized">-</div>
                        <div class="summary-stat-label">Avg Annualized Performance</div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="summary-stat">
                        <div class="summary-stat-value" id="totalFiles">-</div>
                        <div class="summary-stat-label">Total Files</div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="summary-stat">
                        <div class="summary-stat-value" id="positiveCount">-</div>
                        <div class="summary-stat-label">Positive Performance</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Version display -->
    <div class="text-center text-muted small py-2">
      v<span id="version"></span>
    </div>
    
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <!-- DataTables JS -->
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/datetime/1.5.0/js/dataTables.dateTime.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        // Set version display
        document.getElementById('version').textContent = VERSION;
        
        class ScoreFilesList {
            constructor() {
                this.scoreFiles = [];
                this.dataTable = null;
                this.init();
            }
            
            async init() {
                try {
                    await this.loadScoreFiles();
                    this.setupDataTable();
                    this.setupFilters();
                    this.showContent();
                    this.updateSummaryStats();
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showError('Failed to load score files: ' + error.message);
                }
            }
            
            async loadScoreFiles() {
                try {
                    const response = await fetch('scores/index.json');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    this.scoreFiles = data.scores || [];
                    
                    // Sort by date (newest first)
                    this.scoreFiles.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    console.log(`Loaded ${this.scoreFiles.length} score files`);
                } catch (error) {
                    console.error('Error loading score files:', error);
                    throw error;
                }
            }
            
            setupDataTable() {
                try {
                    // Check if DataTables is available
                    if (typeof $.fn.DataTable === 'undefined') {
                        throw new Error('DataTables library not loaded');
                    }
                    
                    this.dataTable = $('#scoreFilesTable').DataTable({
                        data: this.scoreFiles,
                        columns: [
                            { 
                                data: 'date',
                                render: function(data, type, row) {
                                    if (type === 'display') {
                                        const date = new Date(data);
                                        return date.toLocaleDateString('en-US', {
                                            year: 'numeric',
                                            month: 'short',
                                            day: 'numeric'
                                        });
                                    }
                                    return data;
                                }
                            },
                            { 
                                data: 'file',
                                render: function(data, type, row) {
                                    if (type === 'display') {
                                        return data.replace('.tsv', '');
                                    }
                                    return data;
                                }
                            },
                            { 
                                data: 'total_stocks',
                                render: function(data, type, row) {
                                    return data || '-';
                                },
                                type: 'num'
                            },

                            { 
                                data: 'performance_90_day',
                                render: function(data, type, row) {
                                    if (type === 'display') {
                                        if (data !== null && data !== undefined) {
                                            const color = data >= 0 ? 'performance-positive' : 'performance-negative';
                                            const sign = data >= 0 ? '+' : '';
                                            return `<span class="${color}">${sign}${data.toFixed(2)}%</span>`;
                                        }
                                        return '<span class="performance-neutral">-</span>';
                                    }
                                    // Return raw data for sorting and filtering
                                    return data !== null && data !== undefined ? data : -999999;
                                },
                                type: 'num'
                            },
                            { 
                                data: 'performance_annualized',
                                render: function(data, type, row) {
                                    if (type === 'display') {
                                        if (data !== null && data !== undefined) {
                                            const color = data >= 0 ? 'performance-positive' : 'performance-negative';
                                            const sign = data >= 0 ? '+' : '';
                                            return `<span class="${color}">${sign}${data.toFixed(2)}%</span>`;
                                        }
                                        return '<span class="performance-neutral">-</span>';
                                    }
                                    // Return raw data for sorting and filtering
                                    return data !== null && data !== undefined ? data : -999999;
                                },
                                type: 'num'
                            },
                            { 
                                data: null,
                                orderable: false,
                                render: function(data, type, row) {
                                    return `<a href="index.html?file=${encodeURIComponent(row.file)}" class="btn btn-view">
                                        <i class="fas fa-eye me-1"></i>View
                                    </a>`;
                                }
                            }
                        ],
                        order: [[0, 'asc']], // Sort by date ascending (oldest first)
                        pageLength: 50,
                        dom: '<"row"<"col-sm-12 col-md-6"B><"col-sm-12 col-md-6"f>>rtip',
                        buttons: [
                            {
                                extend: 'copy',
                                text: '<i class="fas fa-copy me-1"></i>Copy',
                                className: 'dt-button'
                            },
                            {
                                extend: 'csv',
                                text: '<i class="fas fa-file-csv me-1"></i>CSV',
                                className: 'dt-button'
                            },
                            {
                                extend: 'excel',
                                text: '<i class="fas fa-file-excel me-1"></i>Excel',
                                className: 'dt-button'
                            },
                            {
                                extend: 'print',
                                text: '<i class="fas fa-print me-1"></i>Print',
                                className: 'dt-button'
                            }
                        ],
                        language: {
                            search: "Search dates or files:",
                            lengthMenu: "Show _MENU_ files per page",
                            info: "Showing _START_ to _END_ of _TOTAL_ files",
                            paginate: {
                                first: "First",
                                last: "Last",
                                next: "Next",
                                previous: "Previous"
                            }
                        },
                        search: {
                            smart: true,
                            regex: false,
                            caseInsensitive: true
                        },
                        drawCallback: () => {
                            this.updateSummaryStats();
                        }
                    });
                    
                    console.log('DataTable initialized successfully');
                    
                    // Add placeholder to search box
                    setTimeout(() => {
                        const searchInput = $('.dataTables_filter input');
                        if (searchInput.length > 0) {
                            searchInput.attr('placeholder', 'Search by date (e.g., "2025-06") or file name...');
                            
                            // Add search functionality hints
                            searchInput.on('input', function() {
                                const searchTerm = $(this).val().toLowerCase();
                                if (searchTerm.length > 0) {
                                    console.log(`Searching for: "${searchTerm}"`);
                                }
                            });
                        }
                    }, 100);
                } catch (error) {
                    console.error('Error setting up DataTable:', error);
                    throw error;
                }
            }
            
            setupFilters() {
                try {
                    // Date filters
                    $('#startDate, #endDate').on('change', () => {
                        this.applyFilters();
                    });
                    
                    // Performance filter
                    $('#performanceFilter').on('change', () => {
                        this.applyFilters();
                    });
                    
                    // Clear filters
                    $('#clearFilters').on('click', () => {
                        $('#startDate, #endDate').val('');
                        $('#performanceFilter').val('');
                        this.applyFilters();
                    });
                    
                    console.log('Filters setup completed');
                } catch (error) {
                    console.error('Error setting up filters:', error);
                }
            }
            
            applyFilters() {
                try {
                    if (!this.dataTable) {
                        console.warn('DataTable not initialized, skipping filters');
                        return;
                    }
                    
                    const startDate = $('#startDate').val();
                    const endDate = $('#endDate').val();
                    const performanceFilter = $('#performanceFilter').val();
                    
                    $.fn.dataTable.ext.search.push((settings, data, dataIndex) => {
                        const date = data[0]; // Date column
                        const performance90Day = data[4]; // 90-day performance column (raw data)
                        
                        // Date range filter
                        if (startDate && new Date(date) < new Date(startDate)) {
                            return false;
                        }
                        if (endDate && new Date(date) > new Date(endDate)) {
                            return false;
                        }
                        
                        // Performance filter
                        if (performanceFilter) {
                            // Skip null/undefined values for performance filtering
                            if (performance90Day === null || performance90Day === undefined || performance90Day === -999999) {
                                return false;
                            }
                            
                            switch (performanceFilter) {
                                case 'positive':
                                    return performance90Day > 0;
                                case 'negative':
                                    return performance90Day < 0;
                                case 'above10':
                                    return performance90Day > 10;
                                case 'below-10':
                                    return performance90Day < -10;
                            }
                        }
                        
                        return true;
                    });
                    
                    this.dataTable.draw();
                    
                    // Remove the filter function after drawing
                    $.fn.dataTable.ext.search.pop();
                } catch (error) {
                    console.error('Error applying filters:', error);
                }
            }
            
            updateSummaryStats() {
                try {
                    if (!this.dataTable) {
                        console.warn('DataTable not initialized, skipping summary stats');
                        return;
                    }
                    
                    const visibleData = this.dataTable.rows({ search: 'applied' }).data();
                    let total90Day = 0;
                    let totalAnnualized = 0;
                    let positiveCount = 0;
                    let validCount = 0;
                    
                    visibleData.each((row) => {
                        const performance90Day = row.performance_90_day;
                        const performanceAnnualized = row.performance_annualized;
                        
                        if (performance90Day !== null && performance90Day !== undefined) {
                            total90Day += performance90Day;
                            validCount++;
                            
                            if (performance90Day > 0) {
                                positiveCount++;
                            }
                        }
                        
                        if (performanceAnnualized !== null && performanceAnnualized !== undefined) {
                            totalAnnualized += performanceAnnualized;
                        }
                    });
                    
                    const avg90Day = validCount > 0 ? total90Day / validCount : 0;
                    const avgAnnualized = validCount > 0 ? totalAnnualized / validCount : 0;
                    const totalFiles = visibleData.count();
                    
                    // Update display
                    const avg90DayElement = document.getElementById('avg90Day');
                    const avgAnnualizedElement = document.getElementById('avgAnnualized');
                    const totalFilesElement = document.getElementById('totalFiles');
                    const positiveCountElement = document.getElementById('positiveCount');
                    
                    if (avg90DayElement) {
                        avg90DayElement.textContent = `${avg90Day >= 0 ? '+' : ''}${avg90Day.toFixed(2)}%`;
                        avg90DayElement.className = `summary-stat-value ${avg90Day >= 0 ? 'text-success' : 'text-danger'}`;
                    }
                    
                    if (avgAnnualizedElement) {
                        avgAnnualizedElement.textContent = `${avgAnnualized >= 0 ? '+' : ''}${avgAnnualized.toFixed(2)}%`;
                        avgAnnualizedElement.className = `summary-stat-value ${avgAnnualized >= 0 ? 'text-success' : 'text-danger'}`;
                    }
                    
                    if (totalFilesElement) {
                        totalFilesElement.textContent = totalFiles;
                    }
                    
                    if (positiveCountElement) {
                        positiveCountElement.textContent = `${positiveCount} (${validCount > 0 ? (positiveCount / validCount * 100).toFixed(1) : 0}%)`;
                    }
                } catch (error) {
                    console.error('Error updating summary stats:', error);
                }
            }
            
            showContent() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            }
            
            showError(message) {
                document.getElementById('loading').style.display = 'none';
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                console.error('Error displayed to user:', message);
            }
        }
        
        // Initialize when page loads and all dependencies are ready
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a bit to ensure all scripts are loaded
            setTimeout(() => {
                try {
                    new ScoreFilesList();
                } catch (error) {
                    console.error('Failed to initialize ScoreFilesList:', error);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error').textContent = 'Failed to initialize: ' + error.message;
                    document.getElementById('error').style.display = 'block';
                }
            }, 100);
        });
    </script>
  </body>
</html> 