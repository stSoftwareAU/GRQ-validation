<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    >
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script>
        const VERSION="1.0.76";
        document.title=`GRQ Score Files List v${VERSION}`;
    </script>
    <link rel="icon" type="image/png" href="logo.png" />

    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >

    <!-- Custom styles -->
    <style>
        .header-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .performance-positive {
            color: #10b981 !important;
        }
        
        .performance-negative {
            color: #ef4444 !important;
        }
        
        .performance-neutral {
            color: #6b7280 !important;
        }
        
        .date-filter-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .date-filter-container label {
            font-weight: 600;
            color: #374151;
        }
        
        .date-filter-container .form-select {
            border: 1px solid #d1d5db;
            border-radius: 6px;
        }
        
        .summary-stats {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .summary-stat {
            text-align: center;
        }
        
        .summary-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .summary-stat-label {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .btn-view {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.875rem;
        }
        
        .btn-view:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            color: white;
            text-decoration: none;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }
        
        .error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .table-container {
            width: 100%;
        }
        
        .table-responsive {
            width: 100%;
        }
        
        .score-files-table {
            width: 100% !important;
        }
        
        .dataTables_wrapper {
            width: 100%;
        }
        
        .dataTables_wrapper .dataTables_scroll {
            width: 100%;
        }
        
        .dataTables_wrapper .dataTables_scrollBody {
            width: 100% !important;
        }
        
        .dataTables_wrapper .dataTables_scrollHead {
            width: 100% !important;
        }
        
        .dataTables_wrapper table {
            width: 100% !important;
        }
        
        .dataTables_wrapper .dataTables_scrollHeadInner {
            width: 100% !important;
        }
        
        .dataTables_wrapper .dataTables_scrollHeadInner table {
            width: 100% !important;
        }
        
        .dataTables_wrapper .dataTables_scrollBody table {
            width: 100% !important;
        }
        
        .dataTables_wrapper .dataTables_scrollHead table,
        .dataTables_wrapper .dataTables_scrollBody table {
            width: 100% !important;
            margin: 0 !important;
        }
        
        .dataTables_wrapper .dataTables_scrollHead th,
        .dataTables_wrapper .dataTables_scrollBody td {
            box-sizing: border-box;
        }
        
        .dataTables_wrapper .dataTables_scrollHeadInner {
            width: 100% !important;
            box-sizing: border-box;
        }
        
        .dataTables_wrapper .dataTables_scrollBody {
            width: 100% !important;
            box-sizing: border-box;
        }
        
        .container-fluid {
            max-width: 100%;
            padding-left: 15px;
            padding-right: 15px;
        }
    </style>
  </head>
  <body class="bg-light">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <div class="card shadow-sm border-0">
            <div class="card-header header-gradient text-white text-center py-4">
              <h1 class="display-4 mb-2">GRQ Score Files List</h1>
              <p class="lead mb-0">
                Browse and filter score files by date and performance
              </p>
            </div>

            <div class="card-body p-4">
              <!-- Loading and Error Messages -->
              <div id="loading" class="loading">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading score files...</p>
              </div>

              <div id="error" class="error" style="display: none">
              </div>

              <!-- Content -->
              <div id="content" style="display: none">
                <!-- Date Filters -->
                <div class="date-filter-container">
                  <div class="row">
                    <div class="col-md-3">
                      <label for="startDate" class="form-label">Start Date:</label>
                      <input type="date" id="startDate" class="form-select">
                    </div>
                    <div class="col-md-3">
                      <label for="endDate" class="form-label">End Date:</label>
                      <input type="date" id="endDate" class="form-select">
                    </div>
                    <div class="col-md-3">
                      <label for="performanceFilter" class="form-label">Performance Filter:</label>
                      <select id="performanceFilter" class="form-select">
                        <option value="">All Performance</option>
                        <option value="positive">Positive Only</option>
                        <option value="negative">Negative Only</option>
                        <option value="above10">Above 10%</option>
                        <option value="below-10">Below -10%</option>
                      </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                      <button id="clearFilters" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i>Clear Filters
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Score Files Table -->
                <div class="table-container">
                  <div class="table-header">
                    <h5 class="card-title mb-0">
                      <i class="fas fa-table me-2"></i>
                      Score Files Performance Summary
                    </h5>
                    <div class="alert alert-info mt-3 mb-0">
                      <small>
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>Filter Tips:</strong> Use the date range and performance filters above to find specific data. Click column headers to sort.
                      </small>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table
                      class="table table-hover score-files-table mb-0"
                      id="scoreFilesTable"
                    >
                      <thead class="table-dark">
                        <tr>
                          <th>Date</th>
                          <th>File</th>
                          <th>Total Stocks</th>
                          <th>90-Day Performance</th>
                          <th>Annualized Performance</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody id="scoreFilesTableBody"></tbody>
                    </table>
                  </div>
                </div>

                <!-- Summary Statistics -->
                <div class="summary-stats">
                  <h4 class="text-center mb-4">
                    <i class="fas fa-chart-line me-2"></i>
                    Performance Summary for Selected Files
                  </h4>
                  <div class="row">
                    <div class="col-md-3">
                      <div class="summary-stat">
                        <div class="summary-stat-value" id="avg90Day">-</div>
                        <div class="summary-stat-label">Avg 90-Day Performance</div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="summary-stat">
                        <div class="summary-stat-value" id="avgAnnualized">-</div>
                        <div class="summary-stat-label">Avg Annualized Performance</div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="summary-stat">
                        <div class="summary-stat-value" id="totalFiles">-</div>
                        <div class="summary-stat-label">Total Files</div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="summary-stat">
                        <div class="summary-stat-value" id="positiveCount">-</div>
                        <div class="summary-stat-label">Positive Performance</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Version display -->
    <div class="text-center text-muted small py-2">
      v<span id="version"></span>
    </div>
    
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <!-- DataTables JS -->
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/datetime/1.5.0/js/dataTables.dateTime.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        // Set version display
        document.getElementById('version').textContent = VERSION;
        
        class ScoreFilesList {
            constructor() {
                this.scoreFiles = [];
                this.dataTable = null;
                this.init();
            }
            
            async init() {
                try {
                    await this.loadScoreFiles();
                    this.setupDataTable();
                    this.setupFilters();
                    this.showContent();
                    this.updateSummaryStats();
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showError('Failed to initialize: ' + error.message);
                }
            }
            
            async loadScoreFiles() {
                try {
                    console.log('Loading score files...');
                    const response = await fetch('scores/index.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    this.scoreFiles = data.scores || [];
                    console.log('Loaded score files:', this.scoreFiles.length);
                } catch (error) {
                    console.error('Error loading score files:', error);
                    throw error;
                }
            }
            
            setupDataTable() {
                try {
                    // Check if DataTables is available
                    if (typeof $.fn.DataTable === 'undefined') {
                        throw new Error('DataTables library not loaded');
                    }
                    
                    this.dataTable = $('#scoreFilesTable').DataTable({
                        data: this.scoreFiles,
                        autoWidth: false,
                        scrollX: true,
                        scrollCollapse: true,
                        fixedHeader: true,
                        columns: [
                            { 
                                data: 'date',
                                render: function(data, type, row) {
                                    if (type === 'display') {
                                        const date = new Date(data);
                                        return date.toLocaleDateString('en-US', {
                                            year: 'numeric',
                                            month: 'short',
                                            day: 'numeric'
                                        });
                                    }
                                    return data;
                                }
                            },
                            { 
                                data: 'file',
                                render: function(data, type, row) {
                                    if (type === 'display') {
                                        return data.replace('.tsv', '');
                                    }
                                    return data;
                                }
                            },
                            { 
                                data: 'total_stocks',
                                render: function(data, type, row) {
                                    return data || '-';
                                },
                                type: 'num'
                            },
                            { 
                                data: 'performance_90_day',
                                render: function(data, type, row) {
                                    if (type === 'display') {
                                        if (data !== null && data !== undefined) {
                                            const color = data >= 0 ? 'performance-positive' : 'performance-negative';
                                            const sign = data >= 0 ? '+' : '';
                                            return `<span class="${color}">${sign}${data.toFixed(2)}%</span>`;
                                        }
                                        return '<span class="performance-neutral">-</span>';
                                    }
                                    return data !== null && data !== undefined ? data : -999999;
                                },
                                type: 'num'
                            },
                            { 
                                data: 'performance_annualized',
                                render: function(data, type, row) {
                                    if (type === 'display') {
                                        if (data !== null && data !== undefined) {
                                            const color = data >= 0 ? 'performance-positive' : 'performance-negative';
                                            const sign = data >= 0 ? '+' : '';
                                            return `<span class="${color}">${sign}${data.toFixed(2)}%</span>`;
                                        }
                                        return '<span class="performance-neutral">-</span>';
                                    }
                                    return data !== null && data !== undefined ? data : -999999;
                                },
                                type: 'num'
                            },
                            { 
                                data: null,
                                orderable: false,
                                render: function(data, type, row) {
                                    return `<a href="index.html?file=${encodeURIComponent(row.file)}" class="btn btn-view">
                                        <i class="fas fa-eye me-1"></i>View
                                    </a>`;
                                }
                            }
                        ],
                        order: [[0, 'asc']], // Sort by date ascending (oldest first)
                        pageLength: 50,
                        dom: '<"row"<"col-sm-12"B>>rtip',
                        buttons: [
                            {
                                extend: 'copy',
                                text: '<i class="fas fa-copy me-1"></i>Copy',
                                className: 'dt-button'
                            },
                            {
                                extend: 'csv',
                                text: '<i class="fas fa-file-csv me-1"></i>CSV',
                                className: 'dt-button'
                            },
                            {
                                extend: 'print',
                                text: '<i class="fas fa-print me-1"></i>Print',
                                className: 'dt-button'
                            }
                        ],
                        language: {
                            info: 'Showing _START_ to _END_ of _TOTAL_ score files',
                            lengthMenu: 'Show _MENU_ score files per page',
                            paginate: {
                                first: 'First',
                                last: 'Last',
                                next: 'Next',
                                previous: 'Previous'
                            }
                        },
                        responsive: true,
                        scrollX: true,
                        scrollCollapse: true,
                        drawCallback: () => {
                            this.updateSummaryStats();
                            // Ensure header alignment
                            this.adjustHeaderAlignment();
                        }
                    });
                    
                    console.log('DataTable initialized successfully');
                } catch (error) {
                    console.error('Error setting up DataTable:', error);
                    throw error;
                }
            }
            
            setupFilters() {
                try {
                    // Date filters
                    $('#startDate, #endDate').on('change', () => {
                        this.applyFilters();
                    });
                    
                    // Performance filter
                    $('#performanceFilter').on('change', () => {
                        this.applyFilters();
                    });
                    
                    // Clear filters
                    $('#clearFilters').on('click', () => {
                        $('#startDate, #endDate').val('');
                        $('#performanceFilter').val('');
                        this.applyFilters();
                    });
                    
                    console.log('Filters setup completed');
                } catch (error) {
                    console.error('Error setting up filters:', error);
                }
            }
            
            applyFilters() {
                try {
                    if (!this.dataTable) {
                        console.warn('DataTable not initialized, skipping filters');
                        return;
                    }
                    
                    const startDate = $('#startDate').val();
                    const endDate = $('#endDate').val();
                    const performanceFilter = $('#performanceFilter').val();
                    
                    $.fn.dataTable.ext.search.push((settings, data, dataIndex) => {
                        const date = data[0]; // Date column
                        const performance90Day = data[3]; // 90-day performance column (raw data)
                        
                        // Date range filter
                        if (startDate && new Date(date) < new Date(startDate)) {
                            return false;
                        }
                        if (endDate && new Date(date) > new Date(endDate)) {
                            return false;
                        }
                        
                        // Performance filter
                        if (performanceFilter) {
                            if (performance90Day === null || performance90Day === undefined || performance90Day === -999999) {
                                return false;
                            }
                            
                            switch (performanceFilter) {
                                case 'positive':
                                    return performance90Day > 0;
                                case 'negative':
                                    return performance90Day < 0;
                                case 'above10':
                                    return performance90Day > 10;
                                case 'below-10':
                                    return performance90Day < -10;
                            }
                        }
                        
                        return true;
                    });
                    
                    this.dataTable.draw();
                    
                    // Remove the filter function after drawing
                    $.fn.dataTable.ext.search.pop();
                } catch (error) {
                    console.error('Error applying filters:', error);
                }
            }
            
            updateSummaryStats() {
                try {
                    if (!this.dataTable) {
                        console.warn('DataTable not initialized, skipping summary stats');
                        return;
                    }
                    
                    const visibleData = this.dataTable.rows({ search: 'applied' }).data();
                    let total90Day = 0;
                    let totalAnnualized = 0;
                    let positiveCount = 0;
                    let validCount = 0;
                    
                    visibleData.each((row) => {
                        const performance90Day = row.performance_90_day;
                        const performanceAnnualized = row.performance_annualized;
                        
                        if (performance90Day !== null && performance90Day !== undefined) {
                            total90Day += performance90Day;
                            validCount++;
                            
                            if (performance90Day > 0) {
                                positiveCount++;
                            }
                        }
                        
                        if (performanceAnnualized !== null && performanceAnnualized !== undefined) {
                            totalAnnualized += performanceAnnualized;
                        }
                    });
                    
                    const avg90Day = validCount > 0 ? total90Day / validCount : 0;
                    const avgAnnualized = validCount > 0 ? totalAnnualized / validCount : 0;
                    const totalFiles = visibleData.count();
                    
                    // Update display
                    const avg90DayElement = document.getElementById('avg90Day');
                    const avgAnnualizedElement = document.getElementById('avgAnnualized');
                    const totalFilesElement = document.getElementById('totalFiles');
                    const positiveCountElement = document.getElementById('positiveCount');
                    
                    if (avg90DayElement) {
                        avg90DayElement.textContent = `${avg90Day >= 0 ? '+' : ''}${avg90Day.toFixed(2)}%`;
                        avg90DayElement.className = `summary-stat-value ${avg90Day >= 0 ? 'text-success' : 'text-danger'}`;
                    }
                    
                    if (avgAnnualizedElement) {
                        avgAnnualizedElement.textContent = `${avgAnnualized >= 0 ? '+' : ''}${avgAnnualized.toFixed(2)}%`;
                        avgAnnualizedElement.className = `summary-stat-value ${avgAnnualized >= 0 ? 'text-success' : 'text-danger'}`;
                    }
                    
                    if (totalFilesElement) {
                        totalFilesElement.textContent = totalFiles;
                    }
                    
                    if (positiveCountElement) {
                        positiveCountElement.textContent = `${positiveCount} (${validCount > 0 ? (positiveCount / validCount * 100).toFixed(1) : 0}%)`;
                    }
                } catch (error) {
                    console.error('Error updating summary stats:', error);
                }
            }
            
            showContent() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            }
            
            showError(message) {
                document.getElementById('loading').style.display = 'none';
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                console.error('Error displayed to user:', message);
            }
            
            adjustHeaderAlignment() {
                try {
                    if (!this.dataTable) return;
                    
                    // Force header and body to have the same width
                    const headerTable = this.dataTable.table().header();
                    const bodyTable = this.dataTable.table().body();
                    
                    if (headerTable && bodyTable) {
                        const headerWidth = $(headerTable).width();
                        const bodyWidth = $(bodyTable).width();
                        
                        if (headerWidth !== bodyWidth) {
                            $(headerTable).width(bodyWidth);
                            $(headerTable).find('thead').width(bodyWidth);
                        }
                    }
                } catch (error) {
                    console.warn('Error adjusting header alignment:', error);
                }
            }
        }
        
        // Initialize when page loads and all dependencies are ready
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a bit to ensure all scripts are loaded
            setTimeout(() => {
                try {
                    new ScoreFilesList();
                } catch (error) {
                    console.error('Failed to initialize ScoreFilesList:', error);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error').textContent = 'Failed to initialize: ' + error.message;
                    document.getElementById('error').style.display = 'block';
                }
            }, 100);
        });
    </script>
  </body>
</html> 